generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Passenger {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  numTel    String
  age       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trajets Trajet[]
  savedPlaces SavedPlace[]
}

model Driver {
  id                      Int     @id @default(autoincrement())
  email                   String  @unique
  password                String
  nom                     String
  prenom                  String
  numTel                  String
  sexe                    String
  isVerified              Boolean @default(false)
  age                     Int
  hasAcceptedPhotoStorage Boolean @default(false)

  talkative       Boolean @default(false)
  radio_on        Boolean @default(false)
  smoking_allowed Boolean @default(false)
  pets_allowed    Boolean @default(false)
  car_big         Boolean @default(false)
  works_morning   Boolean @default(false)
  works_afternoon Boolean @default(false)
  works_evening   Boolean @default(false)
  works_night     Boolean @default(false)

  avgRating    Float? @default(0)
  ratingsCount Int?   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verification Verification?
  license      License?
  vehicules    Vehicule[]
  trajets      Trajet[]
}

model Vehicule {
  id       Int     @id @default(autoincrement())
  driverId Int
  marque   String
  modele   String?
  annee    Int?
  nbPlaces Int?
  plaque   String?
  couleur  String?

  driver Driver @relation(fields: [driverId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

model Verification {
  id              Int      @id @default(autoincrement())
  driverId        Int      @unique
  selfieImage     Bytes
  similarityScore Float
  verdict         String
  threshold       Float
  margin          Float
  confidence      String
  licenseQuality  Int?
  selfieQuality   Int?
  isApproved      Boolean  @default(false)
  createdAt       DateTime @default(now())

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)
}

model License {
  id            Int       @id @default(autoincrement())
  driverId      Int       @unique
  ninEncrypted  String    @db.VarChar(500)
  permisImage   Bytes
  issueDate     DateTime?
  expiryDate    DateTime?
  ocrConfidence Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)
}

enum TrajetStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_PASSENGER
  CANCELLED_BY_DRIVER
}

model Trajet {
  id          Int          @id @default(autoincrement())
  driverId    Int?
  passagerId  Int?

  // Adresses texte (pour affichage)
  depart      String
  destination String

  // Coordonnées GPS (pour la carte)
  startLat    Float?
  startLng    Float?
  startAddress String?
  endLat      Float?
  endLng      Float?
  endAddress  String?

  dateDepart  DateTime
  heureDepart String?
  placesDispo Int
  prix        Float
  status      TrajetStatus @default(PENDING)

  // Préférences du passager pour CE trajet (user features LightFM)
  quiet_ride         String @default("no")
  radio_ok           String @default("no")
  smoking_ok         String @default("no")
  pets_ok            String @default("no")
  luggage_large      String @default("no")
  female_driver_pref String @default("no")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  completedAt DateTime?

  driver     Driver?      @relation(fields: [driverId], references: [id])
  passenger  Passenger?  @relation(fields: [passagerId], references: [id])
  evaluation Evaluation?

  @@index([driverId])
  @@index([passagerId])
}

model Evaluation {
  id        Int      @id @default(autoincrement())
  trajetId  Int      @unique
  rating    Float
  comment   String?
  createdAt DateTime @default(now())

  trajet Trajet @relation(fields: [trajetId], references: [id], onDelete: Cascade)
}



model SavedPlace {
  id          Int      @id @default(autoincrement())
  passengerId Int
  label       String
  address     String
  lat         Float
  lng         Float
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  passenger Passenger @relation(fields: [passengerId], references: [id], onDelete: Cascade)

  @@index([passengerId])
}