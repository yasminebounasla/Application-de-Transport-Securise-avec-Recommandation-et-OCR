// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Passager
model Passenger {
  id        Int @id @default(autoincrement())  
  email     String   @unique
  password  String
  nom       String
  prenom    String
  numTel    String
  age       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // préférences pour recommandation
  quiet_ride         Boolean?
  radio_ok           Boolean?
  smoking_ok         Boolean?
  pets_ok            Boolean?
  luggage_large      Boolean?
  female_driver_pref Boolean?

  trajets   Trajet[] @relation("TrajetsPassager")
}

// Conducteur
model Driver {
  id        Int @id @default(autoincrement())  
  email      String   @unique
  password   String
  nom        String
  prenom     String
  numTel     String
  sexe       String // "M" ou "F"
  isVerified Boolean @default(false) // OCR validé
  age        Int

 //  CONSENTEMENT (Checkbox "J'accepte...")
  hasAcceptedPhotoStorage Boolean @default(false)

  // critères pour recommandation
  fumeur           Boolean?
  talkative        Boolean?
  radio_on         Boolean?
  smoking_allowed  Boolean?
  pets_allowed     Boolean?
  car_big          Boolean?
  works_morning    Boolean?
  works_afternoon  Boolean?
  works_evening    Boolean?
  works_night      Boolean?

  note        Float?   // moyenne des évaluations 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  verification     Verification?
  license          License?
  vehicules        Vehicule[]
  trajets          Trajet[]      @relation("TrajetsConducteur")
}

// Vehicule
model Vehicule {
  id        Int @id @default(autoincrement())
  driverId  Int
  marque    String
  modele    String?
  annee     Int?
  nbPlaces  Int?
  plaque    String?
  couleur   String?

  driver    Driver @relation(fields: [driverId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

// --- SERVICE DE VÉRIFICATION & SÉCURITÉ ---

model Verification {
  id              Int      @id @default(autoincrement())
  driverId        Int      @unique
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  // Stockage image
  selfieImage     Bytes    
  
  // Résultats de Reconnaicens
  similarityScore Float    
  verdict         String   // "MATCH" ou "NO_MATCH"
  threshold       Float    // seuil
  margin          Float    
  confidence      String   
  
  // Qualité technique
  licenseQuality  Int?     // Score de netteté permis 
  selfieQuality   Int?     // Score de netteté selfie 
  
  isApproved      Boolean  @default(false)
  createdAt       DateTime @default(now())
}
//permis
model License {
  id            Int      @id @default(autoincrement())
  driverId      Int      @unique
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  // Données sensibles (Chiffrées au niveau applicatif avant stockage)
  ninEncrypted  String   @db.VarChar(500) // Numéro d'identité national chiffré
  permisImage   Bytes    // Image du permis
  
  // Dates du document
  issueDate     DateTime? //date de creation de permis
  expiryDate    DateTime  //date de exprimation de permis
  
  // Métadonnées
  ocrConfidence Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}



// Trajet
model Trajet {
  id          Int @id @default(autoincrement())
  driverId    Int
  passagerId  Int?

  depart      String
  destination String
  dateDepart  DateTime
  heureDepart String?
  placesDispo Int
  prix        Float

  driver      Driver    @relation("TrajetsConducteur", fields: [driverId], references: [id])
  passenger   Passenger? @relation("TrajetsPassager", fields: [passagerId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([driverId])
  @@index([passagerId])
}